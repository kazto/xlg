# Excel Grep Tool 設計書

## 概要
Excel ファイル内の文字列を検索し、grep のような出力形式で結果を表示するコマンドラインツール。
単一ファイル、複数ファイル、ディレクトリ内の全Excelファイルの検索に対応。

## アーキテクチャ

### コマンド構成
```
xlg KEYWORD /path/to/file.xlsx                    # 単一ファイル
xlg KEYWORD file1.xlsx file2.xlsx file3.xlsx     # 複数ファイル
xlg KEYWORD /path/to/directory/                   # ディレクトリ内全検索
```

### 出力形式
```
file.xlsx:シート名:セル位置:マッチした内容
```

### 検索対象ファイル
- `.xlsx` ファイル（Excel 2007以降）
- `.xls` ファイル（Excel 97-2003）
- `.xlsm` ファイル（マクロ有効Excel）

### クラス設計

#### ExcelGrep クラス
- **責務**: メインの検索処理を担当
- **メソッド**:
  - `initialize(keyword, file_path)`: キーワードとファイルパスを初期化
  - `search()`: 検索を実行し結果を出力
  - `validate_file(file_path)`: ファイルの存在確認

#### MultiFileSearcher クラス（新規）
- **責務**: 複数ファイル・ディレクトリ検索の制御
- **メソッド**:
  - `initialize(keyword, paths)`: キーワードと検索パス一覧を初期化
  - `search()`: 全パスに対して検索を実行
  - `expand_paths(paths)`: パス一覧を実際のファイル一覧に展開
  - `find_excel_files(directory)`: ディレクトリ内のExcelファイルを取得

#### CellMatcher クラス
- **責務**: セル内容とキーワードのマッチング処理
- **メソッド**:
  - `match?(cell_value, keyword)`: セル値がキーワードにマッチするかチェック
  - `extract_match(cell_value, keyword)`: マッチした部分を抽出

#### OutputFormatter クラス
- **責務**: 検索結果の出力フォーマット
- **メソッド**:
  - `format(file_name, sheet_name, cell_ref, match_text)`: grep形式の出力を生成

## 処理フロー

### 単一ファイル検索
1. コマンドライン引数の解析
2. Excel ファイルの読み込み (rubyXL)
3. 各シートを順次処理
4. 各セルの内容をキーワードで検索
5. マッチした場合、指定形式で出力

### 複数ファイル・ディレクトリ検索
1. コマンドライン引数の解析
2. パス一覧の展開処理
   - ファイルパス: そのまま追加
   - ディレクトリパス: 内部のExcelファイルを取得して追加
3. 各ファイルに対して単一ファイル検索を実行
4. 検索結果を順次出力

### ディレクトリ検索の詳細
1. ディレクトリ内のファイル一覧を取得
2. 拡張子フィルタリング（.xlsx, .xls, .xlsm）
3. 隠しファイル除外（.で始まるファイル）
4. サブディレクトリは除外（再帰検索なし）

## エラーハンドリング

### ファイル関連エラー
- ファイルが存在しない場合
- Excel ファイルが破損している場合
- 読み込み権限がない場合
- 対応していないファイル形式の場合

### 引数関連エラー
- 引数が不正な場合（キーワードまたはパスが指定されていない）
- 指定されたディレクトリが存在しない場合

### 検索関連エラー
- 複数ファイル検索中の個別ファイルエラー
  - エラーファイルはスキップして続行
  - エラー内容は標準エラーに出力
- ディレクトリ内にExcelファイルが存在しない場合

## 依存関係

- Ruby 標準ライブラリ
- rubyXL gem (Excel ファイル処理)